#!/bin/bash
# ═══════════════════════════════════════════════════════════════════════════════
# urp-secrets: Manage shared API tokens and secrets for URP containers
# ═══════════════════════════════════════════════════════════════════════════════
#
# Usage:
#   urp-secrets                 # Show current secrets (masked)
#   urp-secrets set KEY VALUE   # Set a secret
#   urp-secrets get KEY         # Get a secret value
#   urp-secrets delete KEY      # Delete a secret
#   urp-secrets list            # List all keys
#   urp-secrets edit            # Edit secrets file directly
#   urp-secrets init            # Create template secrets file
#
# Secrets are stored in ~/.urp/secrets.env and mounted in all URP containers.
#

set -e

# Secrets file location
URP_DIR="${URP_DIR:-$HOME/.urp}"
SECRETS_FILE="${URP_SECRETS_FILE:-$URP_DIR/secrets.env}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m'

# Ensure directory exists
mkdir -p "$URP_DIR"

# ─────────────────────────────────────────────────────────────────────────────
# Helper functions
# ─────────────────────────────────────────────────────────────────────────────

mask_value() {
    local value="$1"
    local len=${#value}
    if [ $len -le 8 ]; then
        echo "****"
    else
        echo "${value:0:4}...${value: -4}"
    fi
}

show_secrets() {
    if [ ! -f "$SECRETS_FILE" ]; then
        echo -e "${YELLOW}No secrets file found. Run 'urp-secrets init' to create one.${NC}"
        exit 1
    fi

    echo -e "${MAGENTA}═══════════════════════════════════════════════════════════════${NC}"
    echo -e "${MAGENTA}                    URP Shared Secrets${NC}"
    echo -e "${MAGENTA}═══════════════════════════════════════════════════════════════${NC}"
    echo -e "  File: ${CYAN}$SECRETS_FILE${NC}"
    echo ""
    echo -e "  ${GREEN}KEY${NC}                          ${GREEN}VALUE (masked)${NC}"
    echo "  ─────────────────────────────────────────────────────"

    while IFS='=' read -r key value || [ -n "$key" ]; do
        # Skip comments and empty lines
        [[ "$key" =~ ^#.*$ ]] && continue
        [[ -z "$key" ]] && continue
        # Remove quotes from value
        value="${value%\"}"
        value="${value#\"}"
        value="${value%\'}"
        value="${value#\'}"
        if [ -n "$value" ]; then
            printf "  %-28s %s\n" "$key" "$(mask_value "$value")"
        else
            printf "  %-28s ${YELLOW}(empty)${NC}\n" "$key"
        fi
    done < "$SECRETS_FILE"

    echo ""
}

set_secret() {
    local key="$1"
    local value="$2"

    if [ -z "$key" ] || [ -z "$value" ]; then
        echo -e "${RED}Usage: urp-secrets set KEY VALUE${NC}"
        exit 1
    fi

    # Create file if not exists
    touch "$SECRETS_FILE"
    chmod 600 "$SECRETS_FILE"

    # Check if key exists and update, or append
    if grep -q "^${key}=" "$SECRETS_FILE" 2>/dev/null; then
        # Update existing key (works on both Linux and macOS)
        if [[ "$OSTYPE" == "darwin"* ]]; then
            sed -i '' "s|^${key}=.*|${key}=${value}|" "$SECRETS_FILE"
        else
            sed -i "s|^${key}=.*|${key}=${value}|" "$SECRETS_FILE"
        fi
        echo -e "${GREEN}✓ Updated ${key}${NC}"
    else
        echo "${key}=${value}" >> "$SECRETS_FILE"
        echo -e "${GREEN}✓ Added ${key}${NC}"
    fi
}

get_secret() {
    local key="$1"

    if [ -z "$key" ]; then
        echo -e "${RED}Usage: urp-secrets get KEY${NC}"
        exit 1
    fi

    if [ ! -f "$SECRETS_FILE" ]; then
        echo -e "${RED}No secrets file found${NC}"
        exit 1
    fi

    value=$(grep "^${key}=" "$SECRETS_FILE" | cut -d'=' -f2-)
    if [ -n "$value" ]; then
        # Remove quotes
        value="${value%\"}"
        value="${value#\"}"
        value="${value%\'}"
        value="${value#\'}"
        echo "$value"
    else
        echo -e "${RED}Key not found: ${key}${NC}" >&2
        exit 1
    fi
}

delete_secret() {
    local key="$1"

    if [ -z "$key" ]; then
        echo -e "${RED}Usage: urp-secrets delete KEY${NC}"
        exit 1
    fi

    if [ ! -f "$SECRETS_FILE" ]; then
        echo -e "${RED}No secrets file found${NC}"
        exit 1
    fi

    if grep -q "^${key}=" "$SECRETS_FILE"; then
        if [[ "$OSTYPE" == "darwin"* ]]; then
            sed -i '' "/^${key}=/d" "$SECRETS_FILE"
        else
            sed -i "/^${key}=/d" "$SECRETS_FILE"
        fi
        echo -e "${GREEN}✓ Deleted ${key}${NC}"
    else
        echo -e "${YELLOW}Key not found: ${key}${NC}"
    fi
}

list_keys() {
    if [ ! -f "$SECRETS_FILE" ]; then
        echo -e "${YELLOW}No secrets file found${NC}"
        exit 1
    fi

    grep -v '^#' "$SECRETS_FILE" | grep -v '^$' | cut -d'=' -f1
}

init_secrets() {
    if [ -f "$SECRETS_FILE" ]; then
        echo -e "${YELLOW}Secrets file already exists: $SECRETS_FILE${NC}"
        read -p "Overwrite? (y/N) " confirm
        if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
            echo "Aborted."
            exit 0
        fi
    fi

    cat > "$SECRETS_FILE" << 'EOF'
# ═══════════════════════════════════════════════════════════════════════════════
# URP Shared Secrets
# ═══════════════════════════════════════════════════════════════════════════════
# This file is mounted in all URP containers and loaded automatically.
# Edit with: urp-secrets edit
#
# SECURITY: This file has 600 permissions (owner read/write only)
#

# ─────────────────────────────────────────────────────────────────────────────
# AI/LLM APIs
# ─────────────────────────────────────────────────────────────────────────────

# Anthropic Claude API
# ANTHROPIC_API_KEY=sk-ant-xxx

# OpenAI / GPT
# OPENAI_API_KEY=sk-xxx

# Google Gemini
# GEMINI_API_KEY=xxx
# GOOGLE_API_KEY=xxx

# Groq
# GROQ_API_KEY=xxx

# Together AI
# TOGETHER_API_KEY=xxx

# ─────────────────────────────────────────────────────────────────────────────
# Code & Development
# ─────────────────────────────────────────────────────────────────────────────

# GitHub
# GH_TOKEN=ghp_xxx
# GITHUB_TOKEN=ghp_xxx

# GitLab
# GITLAB_TOKEN=xxx

# ─────────────────────────────────────────────────────────────────────────────
# ML/Data Platforms
# ─────────────────────────────────────────────────────────────────────────────

# Hugging Face
# HF_TOKEN=hf_xxx
# HUGGINGFACE_TOKEN=hf_xxx

# Kaggle
# KAGGLE_USERNAME=xxx
# KAGGLE_KEY=xxx

# Weights & Biases
# WANDB_API_KEY=xxx

# ─────────────────────────────────────────────────────────────────────────────
# Cloud Providers
# ─────────────────────────────────────────────────────────────────────────────

# AWS
# AWS_ACCESS_KEY_ID=xxx
# AWS_SECRET_ACCESS_KEY=xxx
# AWS_DEFAULT_REGION=us-east-1

# Google Cloud
# GOOGLE_APPLICATION_CREDENTIALS=/path/to/credentials.json

# Azure
# AZURE_CLIENT_ID=xxx
# AZURE_CLIENT_SECRET=xxx
# AZURE_TENANT_ID=xxx

# ─────────────────────────────────────────────────────────────────────────────
# Other Services
# ─────────────────────────────────────────────────────────────────────────────

# Slack
# SLACK_BOT_TOKEN=xoxb-xxx

# Discord
# DISCORD_TOKEN=xxx

# Notion
# NOTION_API_KEY=xxx

# Airtable
# AIRTABLE_API_KEY=xxx

EOF

    chmod 600 "$SECRETS_FILE"
    echo -e "${GREEN}✓ Created secrets template: $SECRETS_FILE${NC}"
    echo -e "  Edit with: ${CYAN}urp-secrets edit${NC}"
    echo -e "  Or set individual keys: ${CYAN}urp-secrets set GH_TOKEN ghp_xxx${NC}"
}

edit_secrets() {
    if [ ! -f "$SECRETS_FILE" ]; then
        echo -e "${YELLOW}No secrets file found. Creating template...${NC}"
        init_secrets
    fi

    ${EDITOR:-vim} "$SECRETS_FILE"
}

# ─────────────────────────────────────────────────────────────────────────────
# Main
# ─────────────────────────────────────────────────────────────────────────────

case "${1:-}" in
    "")
        show_secrets
        ;;
    set)
        set_secret "$2" "$3"
        ;;
    get)
        get_secret "$2"
        ;;
    delete|rm)
        delete_secret "$2"
        ;;
    list|ls)
        list_keys
        ;;
    edit)
        edit_secrets
        ;;
    init)
        init_secrets
        ;;
    path)
        echo "$SECRETS_FILE"
        ;;
    help|--help|-h)
        echo "Usage: urp-secrets [command] [args]"
        echo ""
        echo "Commands:"
        echo "  (none)          Show all secrets (masked)"
        echo "  set KEY VALUE   Set a secret"
        echo "  get KEY         Get a secret value"
        echo "  delete KEY      Delete a secret"
        echo "  list            List all keys"
        echo "  edit            Edit secrets file"
        echo "  init            Create template secrets file"
        echo "  path            Show secrets file path"
        echo ""
        echo "Secrets file: $SECRETS_FILE"
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        echo "Run 'urp-secrets help' for usage"
        exit 1
        ;;
esac

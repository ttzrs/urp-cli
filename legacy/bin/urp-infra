#!/bin/bash
# ═══════════════════════════════════════════════════════════════════════════════
# urp-infra: Manage URP shared infrastructure
# ═══════════════════════════════════════════════════════════════════════════════
#
# Usage:
#   urp-infra status    # Show status of all URP containers and volumes
#   urp-infra start     # Start shared infrastructure (memgraph)
#   urp-infra stop      # Stop shared infrastructure
#   urp-infra clean     # Remove all URP containers (keeps volumes)
#   urp-infra purge     # Remove everything including volumes (DESTRUCTIVE)
#   urp-infra lab       # Open Memgraph Lab in browser (temporary container)
#
set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

case "${1:-status}" in
    start)
        echo -e "${GREEN}Starting URP infrastructure...${NC}"
        docker network create urp-network 2>/dev/null || true

        if docker ps -a --format '{{.Names}}' | grep -q '^urp-memgraph$'; then
            docker start urp-memgraph 2>/dev/null || true
        else
            docker run -d \
                --name urp-memgraph \
                --network urp-network \
                --restart unless-stopped \
                -v urp_memgraph_data:/var/lib/memgraph \
                -v urp_memgraph_log:/var/log/memgraph \
                memgraph/memgraph:latest \
                --log-level=WARNING
        fi
        echo -e "${GREEN}✓ Infrastructure started${NC}"
        ;;

    stop)
        echo -e "${YELLOW}Stopping URP infrastructure...${NC}"
        docker stop urp-memgraph 2>/dev/null || true
        echo -e "${GREEN}✓ Infrastructure stopped${NC}"
        ;;

    status)
        echo -e "${CYAN}═══════════════════════════════════════════════════════════${NC}"
        echo -e "${CYAN}                    URP Infrastructure                      ${NC}"
        echo -e "${CYAN}═══════════════════════════════════════════════════════════${NC}"
        echo ""
        echo -e "${GREEN}Containers:${NC}"
        docker ps -a --filter "name=urp-" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" 2>/dev/null || echo "  (none)"
        echo ""
        echo -e "${GREEN}Volumes:${NC}"
        docker volume ls --filter "name=urp_" --format "table {{.Name}}\t{{.Driver}}" 2>/dev/null || echo "  (none)"
        echo ""
        echo -e "${GREEN}Network:${NC}"
        docker network ls --filter "name=urp-network" --format "table {{.Name}}\t{{.Driver}}" 2>/dev/null || echo "  (none)"
        ;;

    clean)
        echo -e "${YELLOW}Removing all URP containers...${NC}"
        # Stop all urp containers
        docker ps -q --filter "name=urp-" | xargs -r docker stop 2>/dev/null || true
        # Remove all urp containers
        docker ps -aq --filter "name=urp-" | xargs -r docker rm 2>/dev/null || true
        echo -e "${GREEN}✓ All URP containers removed${NC}"
        echo -e "${CYAN}  Volumes preserved. Use 'urp-infra purge' to remove everything.${NC}"
        ;;

    lab)
        # Check if memgraph is running
        if ! docker ps --format '{{.Names}}' | grep -q '^urp-memgraph$'; then
            echo -e "${RED}Memgraph not running. Start with: urp-infra start${NC}"
            exit 1
        fi

        # Check if lab already running
        if docker ps --format '{{.Names}}' | grep -q '^urp-lab$'; then
            PORT=$(docker port urp-lab 3000 | cut -d: -f2)
            echo -e "${GREEN}Lab already running at http://localhost:${PORT}${NC}"
            xdg-open "http://localhost:${PORT}" 2>/dev/null || echo "Open: http://localhost:${PORT}"
            exit 0
        fi

        echo -e "${CYAN}Starting Memgraph Lab...${NC}"

        # Run lab on same network, random host port
        docker run -d --rm \
            --name urp-lab \
            --network urp-network \
            -e QUICK_CONNECT_MG_HOST=urp-memgraph \
            -e QUICK_CONNECT_MG_PORT=7687 \
            -p 0:3000 \
            memgraph/lab:latest

        sleep 2
        PORT=$(docker port urp-lab 3000 | cut -d: -f2)

        echo -e "${GREEN}✓ Memgraph Lab running at http://localhost:${PORT}${NC}"
        echo -e "${CYAN}  Connected to urp-memgraph (internal network)${NC}"
        echo -e "${CYAN}  Close browser tab and run 'docker stop urp-lab' when done${NC}"

        # Open browser
        xdg-open "http://localhost:${PORT}" 2>/dev/null || \
        open "http://localhost:${PORT}" 2>/dev/null || \
        echo "Open in browser: http://localhost:${PORT}"
        ;;

    purge)
        echo -e "${RED}⚠️  WARNING: This will delete ALL URP data including:${NC}"
        echo "  - All containers"
        echo "  - Memgraph data (knowledge graph)"
        echo "  - ChromaDB data (embeddings)"
        echo "  - Session data"
        echo ""
        read -p "Are you sure? (type 'yes' to confirm): " confirm
        if [[ "$confirm" == "yes" ]]; then
            echo -e "${YELLOW}Removing everything...${NC}"
            # Stop and remove containers
            docker ps -q --filter "name=urp-" | xargs -r docker stop 2>/dev/null || true
            docker ps -aq --filter "name=urp-" | xargs -r docker rm 2>/dev/null || true
            # Remove volumes
            docker volume rm urp_memgraph_data urp_memgraph_log urp_sessions urp_chroma 2>/dev/null || true
            # Remove network
            docker network rm urp-network 2>/dev/null || true
            echo -e "${GREEN}✓ All URP resources purged${NC}"
        else
            echo -e "${CYAN}Aborted.${NC}"
        fi
        ;;

    *)
        echo "Usage: urp-infra [command]"
        echo ""
        echo "Commands:"
        echo "  status    Show status of all URP containers and volumes (default)"
        echo "  start     Start shared infrastructure (memgraph)"
        echo "  stop      Stop shared infrastructure"
        echo "  lab       Open Memgraph Lab in browser (temporary container)"
        echo "  clean     Remove all URP containers (keeps volumes)"
        echo "  purge     Remove everything including volumes (DESTRUCTIVE)"
        ;;
esac

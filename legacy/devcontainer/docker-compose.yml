# ═══════════════════════════════════════════════════════════════════════════════
# URP Dev Stack - SELinux Compatible + NVIDIA + Shared Memory
# ═══════════════════════════════════════════════════════════════════════════════
#
# Usage:
#   ./urp-dev                              # Launch in current directory
#   ./urp-dev /path/to/project             # Launch in specific directory
#   ./urp-dev --upload knowledge.md        # Upload to shared knowledge
#
# Network: 172.28.0.0/16 (no localhost port mapping)
#   memgraph: 172.28.0.10
#   lab:      172.28.0.11
#   urp:      172.28.0.20
#   dreamer:  172.28.0.21
#
# SELinux: All volumes use :z for proper labeling

services:
  # ─────────────────────────────────────────────────────────────────────────────
  # Graph Database (Memgraph)
  # ─────────────────────────────────────────────────────────────────────────────
  memgraph:
    image: memgraph/memgraph:latest
    hostname: memgraph
    volumes:
      - memgraph_data:/var/lib/memgraph:z
      - memgraph_log:/var/log/memgraph:z
    command: ["--log-level=WARNING"]
    healthcheck:
      test: ["CMD-SHELL", "echo 'RETURN 1;' | mgconsole --no-history 2>/dev/null | grep -q '1'"]
      interval: 5s
      timeout: 10s
      retries: 10
    deploy:
      resources:
        limits:
          memory: 2G
    networks:
      urpnet:
        ipv4_address: 172.28.0.10

  # ─────────────────────────────────────────────────────────────────────────────
  # Memgraph Lab (Optional UI)
  # ─────────────────────────────────────────────────────────────────────────────
  lab:
    image: memgraph/lab:latest
    hostname: lab
    depends_on:
      - memgraph
    environment:
      - QUICK_CONNECT_MG_HOST=172.28.0.10
      - QUICK_CONNECT_MG_PORT=7687
    profiles:
      - ui
    networks:
      urpnet:
        ipv4_address: 172.28.0.11

  # ─────────────────────────────────────────────────────────────────────────────
  # URP Dev Container (Full Stack)
  # ─────────────────────────────────────────────────────────────────────────────
  urp:
    image: urp-devcontainer
    # build:
    #   context: ..
    #   dockerfile: devcontainer/Dockerfile
    hostname: urp
    depends_on:
      memgraph:
        condition: service_started
    environment:
      - NEO4J_URI=bolt://172.28.0.10:7687
      - NEO4J_USER=
      - NEO4J_PASSWORD=
      - URP_ENABLED=1
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - HUGGING_FACE_HUB_TOKEN=${HUGGING_FACE_HUB_TOKEN:-}
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      # NVIDIA
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
    volumes:
      # Docker socket for host Docker access (SELinux :z)
      - /var/run/docker.sock:/var/run/docker.sock:z

      # Project directory (mapped at runtime via CODEBASE_PATH)
      - ${CODEBASE_PATH:-.}:/workspace:z

      # Claude shared memory (persistent across sessions)
      - claude_config:/root/.claude:z

      # Shared knowledge base (upload knowledge here)
      - shared_knowledge:/shared/knowledge:z

      # Session persistence
      - urp_sessions:/shared/sessions:z

      # Git config (from host)
      - ${HOME}/.gitconfig:/root/.gitconfig:ro,z
      - ${HOME}/.ssh:/root/.ssh:ro,z

    working_dir: /workspace
    stdin_open: true
    tty: true
    # SELinux: allow Docker socket access
    security_opt:
      - label=disable
    # NVIDIA runtime
    runtime: nvidia
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    networks:
      urpnet:
        ipv4_address: 172.28.0.20

  # ─────────────────────────────────────────────────────────────────────────────
  # Dreamer (Background Maintenance)
  # ─────────────────────────────────────────────────────────────────────────────
  dreamer:
    build:
      context: ..
      dockerfile: devcontainer/Dockerfile
    hostname: dreamer
    depends_on:
      memgraph:
        condition: service_started
    environment:
      - NEO4J_URI=bolt://172.28.0.10:7687
      - CODEBASE_PATH=/workspace
      - DREAMER_CPU_THRESHOLD=15
      - DREAMER_INTERVAL=60
    volumes:
      - ${CODEBASE_PATH:-.}:/workspace:ro,z
      - shared_knowledge:/shared/knowledge:z
    command: ["python3", "/app/dreamer.py"]
    restart: unless-stopped
    profiles:
      - full
    networks:
      urpnet:
        ipv4_address: 172.28.0.21

# ─────────────────────────────────────────────────────────────────────────────
# Networks
# ─────────────────────────────────────────────────────────────────────────────

networks:
  urpnet:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.28.0.0/16
          gateway: 172.28.0.1

# ─────────────────────────────────────────────────────────────────────────────
# Volumes (Named for persistence)
# ─────────────────────────────────────────────────────────────────────────────

volumes:
  memgraph_data:
    name: urp_memgraph_data
  memgraph_log:
    name: urp_memgraph_log
  claude_config:
    name: urp_claude_config
  shared_knowledge:
    name: urp_shared_knowledge
  urp_sessions:
    name: urp_sessions
